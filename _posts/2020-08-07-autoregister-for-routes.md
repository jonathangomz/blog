---
layout: post
title:  "How auto register routers on Express app"
author: Jonathan GÃ³mez
date:   2020-08-07 12:00:00 -0500
categories: dev
---

A little proyect that auto register routers on a directory to an Express app. By default I set the function poiting to ```_endpoints/``` dir
but have the option to point to another directory... but I dont test it hehe.

Anyway, lets jump to the code

First of all I had to install Node... I will jump this step because I think there are different ways a lot of tutorial of how to install it. But as a note,
I use nvm on zsh with oh my zsh on Linux.

Then I installed the dependencies:

```shell
mkdir autoregister && cd autoregister
npm init -y
npm i -D express 
npm i -D @babel/core @babel/node @babel/preset-env @babel/cli
```
- The first command is to create a directory called ```autoregister/``` and move into it.
- The second command is to initialize and Node project in the current directory and it will have the default configuration, ie. the name of the project will be
the name of the directory.
- The third and four command install the dependencies:
  - express
  - @babel/core
  - @babel/node
  - @babel/preset-dev
  - @babel/cli

I use babel to build and work with ES6 modules, and to build the project to deploy on Heroku. And this is the first time that I use Babel so don't expect
so much :P

> Using Babel is not obligatory but thats why you will see me using ES6 ```imports/exports``` and why I have to exclude some files from ```_endpoints/``` directory.

After that I create a directory named ```src/``` and another one inside this called ```_endpoints/``` like this:
```
node_modules/
src/
  _endpoints/
package.json
package-lock-json
```

Having that I create a file called ```src/app.js``` and wrote the next code:
```js
import express from "express";

const app = express();

export default app;
```
And another one called ```src/index.js``` with the code for starting the app:
```js
import app from "./app.js";

const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log(`Listening to requests on http://localhost:${port}`);
});
```

Now I added the scripts needed to build and start the project on the ```package.json```. Inside the ```"scripts"```:
```
"start": "npm run build && node ./build/index.js",
"build": "npm run clean && npm run build-babel",
"build-babel": "babel -d ./build ./src -s",
"clean": "rm -rf build && mkdir build",
```
At this point the code will not only run but compile and try to run the compiled version of the project that will be inside of an
autogenerated directory called ```build/```.

But it will still not workingbecause the ES6 ```imports/exports``` and I had two options:
* Add ```"type": "module"``` property on my ```package.json```.
* Add Babel (or other tool like these).
I chose the second one because I have so much curiosity on learn how to work with these tools.

To configure Babel to use ES6 modules I had two options again:
* Create a file called ```.babelrc``` with the next code:
```
{
  "presets": [
    "@babel/preset-env"
  ]
}
```
* Add the next property to the bottom of my ```package.json```:
```
"babel": {
  "presets": ["@babel/preset-env"]
}
```
I use the second one but I think it's the same for both cases.

#### After doing this the project ran and now it's time to add the endpoints and the autoregister.
I create the first endpont on a file called ```main.endpoint.js``` with the basic configuration for and endpoint:
```js
import express from "express";
const router = express.Router();

const path = "/";

router.get("", (req, res) => {
  res.json(
    {
      hello: "Hello",
      world: "World",
    }
  );
});

export { path, router };
```

Then I created a file called ```src/routing-register.js``` and here is where the magic happend (at least to me that
I feel so happy to see when I see it worked):
```js
import path from "path";
import fs from "fs";

export const autoregisterEndpoints = (app, pathEndpoints = "_endpoints") => {
  const endpointsPath = path.join(__dirname, pathEndpoints);
  fs.readdirSync(endpointsPath).forEach((file) => {
    let include = includeFile(file);

    if(include){
      let { path, router } = require(`./${pathEndpoints}/` + file);
      app.use(path, router);
    }
  })
}

const includeFile = (file) => {
  const file_splited = file.split('.');
  let extension = file_splited[file_splited.length - 1]
  return extension == "js"
}
```
> I exclude files that not end with ```.js``` because the builded project containt files ```.map``` for every ```.js``` file.

The last thing that I had to do was execute the function on the ```src/app.js``` file passing the main app as the parameter:
```
import express from "express";
import { registerEndpoints } from "./routing-register"; // Added this line

const app = express();

autoregisterEndpoints(app); // Added this line

export default app;
```

Now if you follow these steps and run the app I hope that you will be able to see this on http://localhost:3000/:
```json
{
"hello": "Hello",
"world": "World"
}
```

If you want to add a new endpoint you just have to create a new file on the ```src/_endpoint/``` like the ```main.endpoint.js``` file
and modify the ```path``` constant.
